<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky è‡ªå‹•æ¼”å¥æ©Ÿ (V11 è‡ªè¨‚é¡è‰²ç‰ˆ)</title>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at center bottom, #1a0e2e 0%, #080510 100%);
            --key-bg: rgba(0, 0, 0, 0.4); 
            
            /* --- è‡ªè¨‚è®Šæ•¸å€ --- */
            --line-color: #ffffff; /* ç·šæ¢é è¨­ç™½ï¼Œå¯è‡ªè¨‚ */
            --neon-glow: rgba(255, 255, 255, 0.5); /* ç·šæ¢å…‰æšˆ */
            
            /* æŒ‰ä¸‹æ™‚çš„æ¨£å¼ (å›æ­¸åŠé€æ˜äº®ç™½) */
            --active-bg: rgba(255, 255, 255, 0.6); 
            --active-scale: 0.85;
            
            /* UI */
            --control-bg: rgba(44, 44, 46, 0.9);
            --control-border: rgba(255, 255, 255, 0.15);
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
            overflow: hidden;
            transition: background-image 0.5s ease;
        }

        .bg-stars {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 150px 160px, #ddd, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 200px 200px;
            opacity: 0.3;
            z-index: -1;
        }
        body.custom-bg .bg-stars { display: none; }

        /* --- Controls --- */
        .controls {
            position: absolute;
            top: 20px;
            background: var(--control-bg);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 50px;
            display: flex;
            gap: 8px;
            align-items: center;
            border: 1px solid var(--control-border);
            z-index: 100;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: transform 0.3s, opacity 0.3s;
        }
        .controls.hidden {
            transform: translateY(-150%);
            opacity: 0;
            pointer-events: none;
        }

        .btn {
            background: rgba(255,255,255,0.1);
            color: #eee;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn:hover { background: rgba(255,255,255,0.25); color: #fff; }
        
        .btn-play { background: #ff7675; color: #fff; border: none; font-weight: bold; }
        .btn-play:hover { background: #ff5252; }

        select {
            background: rgba(255,255,255,0.1);
            color: #eee;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            outline: none;
        }
        option { background: #333; }

        /* Color Picker Style */
        .color-wrapper {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 3px 10px 3px 3px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        input[type="color"] {
            border: none; width: 24px; height: 24px; cursor: pointer;
            background: none; padding: 0; border-radius: 50%;
        }
        .color-label { font-size: 12px; color: #ccc; }

        .separator { width: 1px; height: 18px; background: rgba(255,255,255,0.2); margin: 0 2px; }

        #toggleControlsBtn {
            position: fixed; bottom: 20px; right: 20px;
            width: 45px; height: 45px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 22px; color: white;
            z-index: 101; transition: all 0.3s;
        }
        #toggleControlsBtn:hover { transform: scale(1.1); background: rgba(0,0,0,0.8); }
        #toggleControlsBtn.dimmed { opacity: 0.5; }

        /* --- Keyboard Grid --- */
        .instrument-wrapper { transform: scale(1.1); }
        .keys-grid {
            display: grid;
            grid-template-columns: repeat(5, 90px);
            grid-template-rows: repeat(3, 90px);
            gap: 15px;
        }

        /* --- Key Styles (æœ€ä½³åŒ–å»¶é²) --- */
        .key {
            width: 90px; height: 90px;
            background: var(--key-bg);
            border-radius: 22px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            
            /* é—œéµä¿®æ­£ï¼šç§»é™¤å‹•ç•«ï¼Œæ”¹ç”¨æ¥µé€Ÿ transition */
            /* é‡‹æ”¾æ™‚ï¼š0.2s è®Šå›åŸç‹€ (æœ‰å½ˆæ€§) */
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s;
            /* ç¢ºä¿ GPU åŠ é€Ÿ */
            will-change: transform, background;
        }

        /* ç·šæ¢ï¼šä½¿ç”¨è®Šæ•¸æ§åˆ¶é¡è‰² */
        .shape-diamond, .shape-circle, .shape-compound {
            position: absolute;
            border: 3px solid var(--line-color); 
            box-shadow: 0 0 6px var(--neon-glow), inset 0 0 6px var(--neon-glow);
            transition: all 0.1s;
            pointer-events: none;
        }

        .shape-diamond { width: 40px; height: 40px; transform: rotate(45deg); border-radius: 4px; }
        .shape-circle { width: 50px; height: 50px; border-radius: 50%; }
        .shape-compound {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .shape-compound::after {
            content: ''; width: 28px; height: 28px;
            border: 3px solid var(--line-color);
            transform: rotate(45deg); border-radius: 3px;
            box-shadow: 0 0 4px var(--neon-glow), inset 0 0 4px var(--neon-glow);
        }

        /* --- Active State (é›¶å»¶é²è§¸ç™¼) --- */
        .key.active {
            /* æŒ‰ä¸‹æ™‚ï¼šç¬é–“è®Šè‰²ï¼Œç¬é–“ç¸®å° (0s duration) */
            transition: none !important; 
            
            background: var(--active-bg); /* è®Šå›åŠé€æ˜äº®ç™½ */
            transform: scale(var(--active-scale));
            box-shadow: 0 0 25px rgba(255,255,255,0.5); /* æ•´é«”ç™¼å…‰ */
        }
        
        /* æŒ‰ä¸‹æ™‚ç·šæ¢è®Šç´”ç™½ä¸”æ›´äº® */
        .key.active .shape-diamond, 
        .key.active .shape-circle, 
        .key.active .shape-compound,
        .key.active .shape-compound::after {
            border-color: #ffffff;
            box-shadow: 0 0 15px #ffffff, inset 0 0 10px #ffffff;
            filter: brightness(1.5);
        }

        #statusMsg { color: #aaa; font-size: 12px; white-space: nowrap; margin-left: 5px; }

    </style>
</head>
<body>

    <div class="bg-stars"></div>

    <div class="controls" id="controlsPanel">
        <input type="file" id="midiFileInput" accept=".mid,.midi" onchange="handleMidiFile(this.files)" style="display:none">
        <button class="btn" id="midiBtn" onclick="document.getElementById('midiFileInput').click()">ğŸ“‚ ä¸Šå‚³ MIDI</button>
        
        <input type="file" id="bgFileInput" accept="image/*" onchange="handleBgFile(this.files)" style="display:none">
        <button class="btn" id="bgBtn" onclick="document.getElementById('bgFileInput').click()">ğŸ–¼ï¸ ä¸Šå‚³èƒŒæ™¯</button>

        <div class="color-wrapper" title="è‡ªè¨‚ç·šæ¢é¡è‰²">
            <input type="color" id="lineColorPicker" value="#ffffff" oninput="updateLineColor(this.value)">
            <span class="color-label">ç·šæ¢</span>
        </div>

        <select id="instrumentSelect" onchange="changeInstrument()">
            <optgroup label="å…§å»ºåˆæˆéŸ³ (å¿«é€Ÿ)">
                <option value="harp" selected>é è¨­è±ç´</option>
                <option value="piano">é‹¼ç´</option>
                <option value="guitar">å‰ä»–</option>
                <option value="synth">é›»å­éŸ³</option>
            </optgroup>
            <optgroup label="å¤–éƒ¨éŸ³æº (éœ€ä¸Šå‚³)">
                <option value="custom">piano01 </option>
            </optgroup>
        </select>

        <div class="separator"></div>

        <button class="btn btn-play" id="playBtn" onclick="togglePlay()">â–¶ æ’­æ”¾</button>
        <button class="btn" onclick="stopPlay()">â–  åœæ­¢</button>
        <span id="statusMsg">è«‹é¸æ“‡æª”æ¡ˆ...</span>
    </div>

    <div class="instrument-wrapper">
        <div class="keys-grid" id="keyboard"></div>
    </div>

    <div id="toggleControlsBtn" onclick="toggleControls()">ğŸ‘ï¸</div>

    <script>
        const SHAPE_LAYOUT = [
            'compound', 'diamond', 'circle', 'diamond', 'circle',    // Row 1
            'circle', 'diamond', 'compound', 'diamond', 'circle',    // Row 2
            'circle', 'diamond', 'circle', 'diamond', 'compound'     // Row 3
        ];

        const SKY_NOTES = [60, 62, 64, 65, 67, 69, 71, 72, 74, 76, 77, 79, 81, 83, 84];

        let currentMidi = null;
        let synth = null;
        let shiftAmount = 0;
        let isPlaying = false;
        const keyboard = document.getElementById('keyboard');
        const statusMsg = document.getElementById('statusMsg');
        const playBtn = document.getElementById('playBtn');
        const body = document.body;
        const controlsPanel = document.getElementById('controlsPanel');
        const toggleBtn = document.getElementById('toggleControlsBtn');

        function truncateName(name, maxLength = 8) {
            if (name.length <= maxLength) return name;
            const extIndex = name.lastIndexOf('.');
            if (extIndex !== -1) {
                const ext = name.substring(extIndex);
                const base = name.substring(0, extIndex);
                if (base.length > maxLength - ext.length - 2) {
                    return base.substring(0, maxLength - ext.length - 2) + '..' + ext;
                }
            }
            return name.substring(0, maxLength) + '...';
        }

        function initKeyboard() {
            keyboard.innerHTML = '';
            SHAPE_LAYOUT.forEach((shapeType, index) => {
                const key = document.createElement('div');
                key.className = 'key';
                key.id = `sky-key-${index}`;
                
                const shape = document.createElement('div');
                shape.className = `shape-${shapeType}`;
                
                key.appendChild(shape);
                keyboard.appendChild(key);

                key.addEventListener('mousedown', () => {
                    if (!synth) initAudio();
                    const now = Tone.now();
                    synth.triggerAttackRelease(Tone.Frequency(SKY_NOTES[index], "midi"), 0.5, now);
                    
                    // æ‰‹å‹•é»æ“Šè¦–è¦ºåé¥‹
                    key.classList.add('active');
                    // æ¨¡æ“¬æ‰‹æŒ‡æ”¾é–‹ (0.2s å¾Œ)
                    setTimeout(() => key.classList.remove('active'), 200);
                });
            });
        }

        // --- é¡è‰²æ›´æ–° ---
        function updateLineColor(color) {
            document.documentElement.style.setProperty('--line-color', color);
            // è¨ˆç®—å…‰æšˆé¡è‰² (å°‡ hex è½‰ç‚º rgba åŠé€æ˜)
            const r = parseInt(color.substr(1,2), 16);
            const g = parseInt(color.substr(3,2), 16);
            const b = parseInt(color.substr(5,2), 16);
            document.documentElement.style.setProperty('--neon-glow', `rgba(${r},${g},${b},0.5)`);
        }

        async function handleMidiFile(files) {
            if (files.length === 0) return;
            stopPlay();
            statusMsg.innerText = "è§£æä¸­...";
            
            const btn = document.getElementById('midiBtn');
            btn.innerText = 'ğŸ“‚ ' + truncateName(files[0].name);
            btn.title = files[0].name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try { currentMidi = new Midi(e.target.result); autoRecommend(); } 
                catch (err) { statusMsg.innerText = "å¤±æ•—"; }
            };
            reader.readAsArrayBuffer(files[0]);
        }

        function handleBgFile(files) {
            if (files.length === 0) return;
            const btn = document.getElementById('bgBtn');
            btn.innerText = 'ğŸ–¼ï¸ ' + truncateName(files[0].name);
            btn.title = files[0].name;

            const file = files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                body.style.backgroundImage = `url('${e.target.result}')`;
                body.classList.add('custom-bg');
            };
            reader.readAsDataURL(file);
        }

        function autoRecommend() {
            if(!currentMidi) return;
            let bestShift = 0;
            let minInvalid = Infinity;
            for(let s = -11; s <= 11; s++) {
                let invalid = 0;
                currentMidi.tracks.forEach(track => {
                    track.notes.forEach(note => {
                        let m = note.midi + s;
                        while (m < 60) m += 12; while (m > 84) m -= 12;
                        if (!SKY_NOTES.includes(m)) invalid++;
                    });
                });
                if(invalid < minInvalid) { minInvalid = invalid; bestShift = s; }
            }
            shiftAmount = bestShift;
            statusMsg.innerText = `å°±ç·’ (è‡ªå‹•è½‰èª¿ ${shiftAmount > 0 ? '+' : ''}${shiftAmount})`;
        }

// æ–°å¢ä¸€å€‹è®Šæ•¸ä¾†ç®¡ç†æ¡æ¨£å™¨
        let sampler = null;

        async function changeInstrument() {
            // ç¢ºä¿ Tone.js å·²å•Ÿå‹•
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }

            const type = document.getElementById('instrumentSelect').value;
            const btn = document.getElementById('playBtn');
            const originalText = "â–¶ æ’­æ”¾"; // æˆ–æ˜¯ä¿ç•™æŒ‰éˆ•ç•¶å‰æ–‡å­—

            // 1. åœæ­¢ä¸¦é‡‹æ”¾ç•¶å‰çš„è²éŸ³
            if (synth) {
                synth.releaseAll();
                // å¦‚æœä¹‹å‰æ˜¯åˆæˆå™¨ï¼Œæˆ‘å€‘å¯ä»¥ä¿ç•™è®Šæ•¸ï¼›å¦‚æœæ˜¯æ¡æ¨£å™¨ï¼Œç¨å¾Œæœƒè¦†è“‹
            }

            // 2. åˆ¤æ–·æ˜¯ç”¨ã€Œå¤–éƒ¨æ¡æ¨£ã€é‚„æ˜¯ã€Œå…§å»ºåˆæˆã€
            if (type === 'custom') {
                // === æ¨¡å¼ A: è®€å– sounds è³‡æ–™å¤¾çš„ MP3 ===
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                btn.innerText = "â³ è¼‰å…¥éŸ³è‰²ä¸­...";
                btn.disabled = true;

                // å»ºç«‹æ¡æ¨£å™¨
                sampler = new Tone.Sampler({
                    urls: {
                        // å°æ‡‰å…‰é‡ 15 éŸ³ (C4 ~ C6)
                        'C4': '01.mp3', 'D4': '02.mp3', 'E4': '03.mp3', 'F4': '04.mp3', 'G4': '05.mp3',
                        'A4': '06.mp3', 'B4': '07.mp3', 'C5': '08.mp3', 'D5': '09.mp3', 'E5': '10.mp3',
                        'F5': '11.mp3', 'G5': '12.mp3', 'A5': '13.mp3', 'B5': '14.mp3', 'C6': '15.mp3'
                    },
                    baseUrl: "./sounds/", // é€™è£¡æŒ‡å®šä½ çš„è³‡æ–™å¤¾è·¯å¾‘
                    onload: () => {
                        console.log("Custom sounds loaded!");
                        btn.innerText = originalText; // æ¢å¾©æŒ‰éˆ•æ–‡å­—
                        btn.disabled = false;
                        sampler.volume.value = -5;
                    },
                    onerror: (err) => {
                        console.error("éŸ³æ•ˆè¼‰å…¥å¤±æ•—", err);
                        alert("ç„¡æ³•è®€å–éŸ³æ•ˆæª”ï¼è«‹ç¢ºèªï¼š\n1. æ‚¨çš„ sounds è³‡æ–™å¤¾è£¡æ˜¯å¦æœ‰ 01.mp3 ~ 15.mp3\n2. æ˜¯å¦å·²ä¸Šå‚³åˆ° GitHub Pages (æœ¬åœ°ç«¯ç›´æ¥é–‹å•Ÿå¯èƒ½æœƒè¢«ç€è¦½å™¨é˜»æ“‹)");
                        btn.innerText = originalText;
                        btn.disabled = false;
                        // å¤±æ•—æ™‚åˆ‡å›é è¨­
                        document.getElementById('instrumentSelect').value = 'harp';
                        changeInstrument();
                    }
                }).toDestination();

                // å°‡ä¸»åˆæˆå™¨è®Šæ•¸æŒ‡å‘æ¡æ¨£å™¨ï¼Œé€™æ¨£æ’­æ”¾é‚è¼¯ä¸ç”¨æ”¹
                synth = sampler;

            } else {
                // === æ¨¡å¼ B: ä½¿ç”¨å…§å»ºåˆæˆå™¨ (ç„¡éœ€æª”æ¡ˆ) ===
                
                // å¦‚æœä¹‹å‰æ˜¯æ¡æ¨£å™¨ï¼Œç¾åœ¨åˆ‡æ›å›åˆæˆå™¨ï¼Œé‡æ–°å»ºç«‹ä¸€å€‹ PolySynth
                // æˆ–è€…ç›´æ¥è¦†è“‹ synth è®Šæ•¸
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ (åˆæˆå™¨åˆ‡æ›æ˜¯ç¬é–“çš„)
                btn.innerText = originalText;
                btn.disabled = false;

                // è¨­å®šåƒæ•¸
                const commonEnvelope = { attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.1 };

                switch(type) {
                    case 'piano':
                        synth.set({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 1.5 } }); 
                        synth.volume.value = -5; 
                        break;
                    case 'guitar':
                        synth.set({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1 } }); 
                        synth.volume.value = -8; 
                        break;
                    case 'synth':
                        synth.set({ oscillator: { type: "square" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }); 
                        synth.volume.value = -10; 
                        break;
                    case 'harp': 
                    default:
                        synth.set({ oscillator: { type: "triangle" }, envelope: commonEnvelope }); 
                        synth.volume.value = -5; 
                        break;
                }
            }
        }

        async function initAudio() {
            if (!synth) {
                await Tone.start();
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                changeInstrument();
            }
        }

        async function togglePlay() {
            await initAudio();
            if (isPlaying) { stopPlay(); } else {
                if (!currentMidi) return;
                scheduleMusic();
                Tone.Transport.start();
                playBtn.innerText = "â¸ æš«åœ";
                isPlaying = true;
            }
        }

        function stopPlay() {
            if(synth) synth.releaseAll();
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('.key.active').forEach(el => el.classList.remove('active'));
            playBtn.innerText = "â–¶ æ’­æ”¾";
            isPlaying = false;
        }

        function scheduleMusic() {
            Tone.Transport.cancel();
            let endTime = 0;
            currentMidi.tracks.forEach(track => {
                track.notes.forEach(note => {
                    let playMidi = note.midi + shiftAmount;
                    while (playMidi < 60) playMidi += 12; while (playMidi > 84) playMidi -= 12;
                    const keyIndex = SKY_NOTES.indexOf(playMidi);
                    if (keyIndex !== -1) {
                        
                        // éŸ³è¨Šæ’ç¨‹
                        Tone.Transport.schedule((time) => {
                            const freq = Tone.Frequency(playMidi, "midi");
                            synth.triggerAttackRelease(freq, note.duration, time);

                            // è¦–è¦ºæ’ç¨‹ (åŒæ­¥)
                            Tone.Draw.schedule(() => {
                                const el = document.getElementById(`sky-key-${keyIndex}`);
                                if (el) {
                                    el.classList.add('active');
                                }
                            }, time);

                            // è¦–è¦ºçµæŸ (å»¶éŸ³)
                            Tone.Draw.schedule(() => {
                                const el = document.getElementById(`sky-key-${keyIndex}`);
                                if (el) el.classList.remove('active');
                            }, time + note.duration);

                        }, note.time);
                        
                        if(note.time + note.duration > endTime) endTime = note.time + note.duration;
                    }
                });
            });
            Tone.Transport.schedule(() => stopPlay(), endTime + 1);
        }

        let controlsVisible = true;
        function toggleControls() {
            controlsVisible = !controlsVisible;
            if (controlsVisible) {
                controlsPanel.classList.remove('hidden');
                toggleBtn.classList.remove('dimmed');
            } else {
                controlsPanel.classList.add('hidden');
                toggleBtn.classList.add('dimmed');
            }
        }

        initKeyboard();

    </script>
</body>
</html>