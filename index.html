<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky Ëá™ÂãïÊºîÂ•èÊ©ü (V27 Èò≤ÁàÜÈü≥Áâà)</title>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-gradient: radial-gradient(circle at center bottom, #1a0e2e 0%, #080510 100%);
            --key-bg: rgba(0, 0, 0, 0.25); 
            --key-border: rgba(255, 255, 255, 0.5);
            --line-color: #ffffff; 
            --neon-glow: 0 0 4px rgba(255, 255, 255, 0.4); 
            --active-bg: rgba(255, 255, 255, 0.3); 
            --active-border: #ffffff;
            --control-bg: rgba(44, 44, 46, 0.9);
            --control-border: rgba(255, 255, 255, 0.15);
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-gradient);
            background-size: cover; background-position: center; background-attachment: fixed;
            color: white; font-family: 'Segoe UI', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            user-select: none; overflow: hidden;
            transition: background-image 0.5s ease;
        }

        .bg-stars {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 150px 160px, #ddd, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 200px 200px;
            opacity: 0.3; z-index: -1;
        }
        body.custom-bg .bg-stars { display: none; }

        /* --- Controls --- */
        .controls {
            position: absolute; top: 20px;
            background: var(--control-bg); backdrop-filter: blur(10px);
            padding: 8px 15px; border-radius: 50px;
            display: flex; gap: 8px; align-items: center;
            border: 1px solid var(--control-border);
            z-index: 100; flex-wrap: wrap; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: transform 0.3s, opacity 0.3s;
        }
        .controls.hidden { transform: translateY(-150%); opacity: 0; pointer-events: none; }

        .btn {
            background: rgba(255,255,255,0.1); color: #eee;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 14px; border-radius: 20px;
            cursor: pointer; font-size: 13px; transition: 0.2s;
            white-space: nowrap;
        }
        .btn:hover { background: rgba(255,255,255,0.25); color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-play { background: #ff7675; color: #fff; border: none; font-weight: bold; }
        .btn-play:hover { background: #ff5252; }

        select {
            background: rgba(255,255,255,0.1); color: #eee;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 10px; border-radius: 20px;
            cursor: pointer; font-size: 13px; outline: none;
        }
        option { background: #333; }

        .color-wrapper {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.1); padding: 3px 10px 3px 3px;
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; border-radius: 50%; }
        .color-label { font-size: 12px; color: #ccc; }
        
        /* Èü≥ÈáèÊãâÊ°ø */
        .vol-wrapper {
            display: flex; align-items: center; gap: 5px;
        }
        input[type="range"] { width: 60px; cursor: pointer; }

        .separator { width: 1px; height: 18px; background: rgba(255,255,255,0.2); margin: 0 2px; }

        #toggleControlsBtn {
            position: fixed; bottom: 20px; right: 20px;
            width: 45px; height: 45px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 22px; color: white;
            z-index: 101; transition: all 0.3s;
        }
        #toggleControlsBtn:hover { transform: scale(1.1); background: rgba(0,0,0,0.8); }
        #toggleControlsBtn.dimmed { opacity: 0.5; }

        /* --- Keyboard Grid --- */
        .instrument-wrapper { transform: scale(1.1); }
        .keys-grid {
            display: grid;
            grid-template-columns: repeat(5, 90px);
            grid-template-rows: repeat(3, 90px);
            gap: 15px;
        }

        /* --- Key Styles --- */
        .key {
            width: 90px; height: 90px;
            background: var(--key-bg);
            border-radius: 18px; 
            border: 2px solid var(--key-border);
            display: flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.1s ease-out, background 0.1s, border-color 0.1s;
        }

        .shape-diamond, .shape-circle, .shape-compound {
            position: absolute;
            border: 3px solid var(--line-color); 
            box-shadow: var(--neon-glow);
            pointer-events: none;
            transition: transform 0.1s;
        }

        .shape-diamond { width: 44px; height: 44px; transform: rotate(45deg); border-radius: 4px; }
        .shape-circle { width: 54px; height: 54px; border-radius: 50%; }
        .shape-compound {
            width: 44px; height: 44px; transform: rotate(45deg); border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .shape-compound::after {
            content: ''; width: 30px; height: 30px;
            border: 3px solid var(--line-color); border-radius: 50%;
            box-shadow: var(--neon-glow);
        }

        /* --- Active State --- */
        .key.active {
            transform: scale(0.85);
            background: var(--active-bg);
            border-color: #fff;
            transition: none;
        }

        .key::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 18px;
            opacity: 0; pointer-events: none; box-sizing: border-box;
        }
        .key.active::after { animation: ringExpand 0.3s ease-out forwards; }

        @keyframes ringExpand {
            0% { width: 100%; height: 100%; opacity: 1; border-width: 4px; }
            100% { width: 140%; height: 140%; opacity: 0; border-width: 0px; }
        }

        #statusMsg { color: #aaa; font-size: 12px; white-space: nowrap; margin-left: 5px; }

    </style>
</head>
<body>

    <div class="bg-stars"></div>

    <div class="controls" id="controlsPanel">
        <input type="file" id="midiFileInput" accept=".mid,.midi,.txt,.json" onchange="handleFileSelect(this.files)" style="display:none">
        <button class="btn" id="fileBtn" onclick="document.getElementById('midiFileInput').click()">üìÇ Ë≠úÊ™î</button>
        
        <input type="file" id="bgFileInput" accept="image/*" onchange="handleBgFile(this.files)" style="display:none">
        <button class="btn" id="bgBtn" onclick="document.getElementById('bgFileInput').click()">üñºÔ∏è ËÉåÊôØ</button>

        <div class="color-wrapper" title="Ëá™Ë®ÇÁ∑öÊ¢ùÈ°èËâ≤">
            <input type="color" id="lineColorPicker" value="#ffffff" oninput="updateLineColor(this.value)">
        </div>
        
        <div class="vol-wrapper" title="Èü≥Èáè">
            <span style="font-size:12px">üîä</span>
            <input type="range" id="volumeControl" min="-30" max="0" value="-10" oninput="updateVolume(this.value)">
        </div>

        <select id="instrumentSelect" onchange="changeInstrument()">
            <optgroup label="ÂÖßÂª∫ÂêàÊàêÈü≥">
                <option value="harp" selected>È†êË®≠Ë±éÁê¥</option>
                <option value="piano">ÈãºÁê¥</option>
                <option value="guitar">Âêâ‰ªñ</option>
                <option value="synth">ÈõªÂ≠êÈü≥</option>
            </optgroup>
            <optgroup label="Â§ñÈÉ®Èü≥Ê∫ê">
                <option value="custom">‚ú® Ëá™Ë®Ç/ÂéüËÅ≤</option>
            </optgroup>
        </select>

        <div class="separator"></div>

        <button class="btn btn-play" id="playBtn" onclick="togglePlay()">‚ñ∂ Êí≠Êîæ</button>
        <button class="btn" onclick="stopPlay()">‚ñ† ÂÅúÊ≠¢</button>
        <button class="btn" onclick="downloadScore()">üì• Êà™Âúñ</button>
        
        <span id="statusMsg">Ë´ã‰∏äÂÇ≥Ê™îÊ°à...</span>
    </div>

    <div class="instrument-wrapper">
        <div class="keys-grid" id="keyboard"></div>
    </div>

    <div id="toggleControlsBtn" onclick="toggleControls()">üëÅÔ∏è</div>

    <script>
        const SHAPE_LAYOUT = [
            'compound', 'diamond', 'circle', 'diamond', 'circle',    
            'circle', 'diamond', 'compound', 'diamond', 'circle',    
            'circle', 'diamond', 'circle', 'diamond', 'compound'     
        ];

        const SKY_NOTES = [60, 62, 64, 65, 67, 69, 71, 72, 74, 76, 77, 79, 81, 83, 84];

        let currentMidi = null;
        let globalSynth = null;
        let sampler = null;
        let shiftAmount = 0;
        let isPlaying = false;
        
        // Èò≤ÁàÜÈü≥ÈôêÂà∂Âô® (Limiter)
        // threshold: -2dB (Ë∂ÖÈÅéÈÄôÂÄãÈü≥ÈáèÂ∞±ÊúÉË¢´Â£ì‰∏ã‰æÜ)
        const limiter = new Tone.Limiter(-2).toDestination();

        const keyboard = document.getElementById('keyboard');
        const statusMsg = document.getElementById('statusMsg');
        const playBtn = document.getElementById('playBtn');
        const body = document.body;
        const controlsPanel = document.getElementById('controlsPanel');
        const toggleBtn = document.getElementById('toggleControlsBtn');

        function truncateName(name, maxLength = 6) {
            if (name.length <= maxLength) return name;
            const extIndex = name.lastIndexOf('.');
            if (extIndex !== -1) {
                const ext = name.substring(extIndex);
                const base = name.substring(0, extIndex);
                if (base.length > maxLength - ext.length - 1) {
                    return base.substring(0, maxLength - ext.length - 1) + '..' + ext;
                }
            }
            return name.substring(0, maxLength) + '..';
        }

        function initKeyboard() {
            keyboard.innerHTML = '';
            SHAPE_LAYOUT.forEach((shapeType, index) => {
                const key = document.createElement('div');
                key.className = 'key';
                key.id = `sky-key-${index}`;
                
                const shape = document.createElement('div');
                shape.className = `shape-${shapeType}`;
                
                key.appendChild(shape);
                keyboard.appendChild(key);

                key.addEventListener('mousedown', () => {
                    ensureAudioInit().then(() => {
                        if(globalSynth) {
                            const now = Tone.now();
                            globalSynth.triggerAttackRelease(Tone.Frequency(SKY_NOTES[index], "midi"), 2.0, now);
                        }
                        key.classList.remove('active');
                        void key.offsetWidth; 
                        key.classList.add('active');
                        setTimeout(() => key.classList.remove('active'), 150);
                    });
                });
            });
        }

        function updateLineColor(color) {
            document.documentElement.style.setProperty('--line-color', color);
            const r = parseInt(color.substr(1,2), 16);
            const g = parseInt(color.substr(3,2), 16);
            const b = parseInt(color.substr(5,2), 16);
            document.documentElement.style.setProperty('--neon-glow', `0 0 4px rgba(${r},${g},${b},0.6)`);
        }
        
        function updateVolume(val) {
            if(globalSynth) {
                globalSynth.volume.value = val;
            }
        }

        async function handleFileSelect(files) {
            if (files.length === 0) return;
            stopPlay();
            statusMsg.innerText = "Ëß£Êûê‰∏≠...";
            
            const file = files[0];
            const btn = document.getElementById('fileBtn');
            btn.innerText = 'üìÇ ' + truncateName(file.name);
            btn.title = file.name;

            const fileName = file.name.toLowerCase();
            if (fileName.endsWith('.mid') || fileName.endsWith('.midi')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        currentMidi = new Midi(e.target.result);
                        autoRecommend();
                    } catch (err) {
                        statusMsg.innerText = "MIDI Ëß£ÊûêÂ§±Êïó";
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (fileName.endsWith('.txt') || fileName.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = function(e) { parseSkyText(e.target.result); };
                reader.readAsText(file);
            } else {
                statusMsg.innerText = "Ê†ºÂºèÈåØË™§";
            }
        }

        function parseSkyText(text) {
            try {
                let data = JSON.parse(text);
                let rawList = [];
                if (Array.isArray(data)) {
                    if (data.length > 0 && data[0].notes) {
                         data.forEach(frame => {
                             if(frame.notes) frame.notes.forEach(n => rawList.push({ time: frame.time, key: n.key }));
                         });
                    } else { rawList = data; }
                } else if (data.songNotes) { rawList = data.songNotes; }

                const convertedNotes = [];
                rawList.forEach(noteItem => {
                    let time = noteItem.time !== undefined ? noteItem.time : (noteItem.startTime || 0);
                    let keyStr = noteItem.key || ""; 
                    let duration = noteItem.duration || 200;
                    const match = keyStr.match(/Key(\d+)/i);
                    if (match) {
                        let keyIndex = parseInt(match[1]);
                        if (keyIndex >= 0 && keyIndex < 15) {
                            convertedNotes.push({
                                midi: SKY_NOTES[keyIndex],
                                time: time / 1000,
                                duration: duration / 1000
                            });
                        }
                    }
                });

                if (convertedNotes.length === 0) { statusMsg.innerText = "ÁÑ°ÊúâÊïàÈü≥Á¨¶"; return; }
                currentMidi = { tracks: [ { notes: convertedNotes } ], header: null };
                shiftAmount = 0;
                statusMsg.innerText = `Â∞±Á∑í (${convertedNotes.length} Èü≥)`;

            } catch (err) { statusMsg.innerText = "Ëß£ÊûêÂ§±Êïó"; }
        }

        function handleBgFile(files) {
            if (files.length === 0) return;
            const btn = document.getElementById('bgBtn');
            btn.innerText = 'üñºÔ∏è ' + truncateName(files[0].name);
            btn.title = files[0].name;
            const file = files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                body.style.backgroundImage = `url('${e.target.result}')`;
                body.classList.add('custom-bg');
            };
            reader.readAsDataURL(file);
        }

        function autoRecommend() {
            if(!currentMidi || !currentMidi.tracks) return;
            if (!currentMidi.header) { shiftAmount = 0; return; }
            stopPlay();
            let bestShift = 0;
            let minInvalid = Infinity;
            for(let s = -11; s <= 11; s++) {
                let invalid = 0;
                currentMidi.tracks.forEach(track => {
                    track.notes.forEach(note => {
                        let m = note.midi + s;
                        while (m < 60) m += 12; while (m > 84) m -= 12;
                        if (!SKY_NOTES.includes(m)) invalid++;
                    });
                });
                if(invalid < minInvalid) { minInvalid = invalid; bestShift = s; }
            }
            shiftAmount = bestShift;
            statusMsg.innerText = `Â∞±Á∑í (Ëá™ÂãïËΩâË™ø ${shiftAmount > 0 ? '+' : ''}${shiftAmount})`;
        }

        async function ensureAudioInit() {
            if (Tone.context.state !== 'running') { await Tone.start(); }
            if (!globalSynth) { await changeInstrument(); }
        }

        async function changeInstrument() {
            const type = document.getElementById('instrumentSelect').value;
            const vol = document.getElementById('volumeControl').value;
            if(isPlaying) stopPlay();
            if (globalSynth) { globalSynth.releaseAll(); }
            playBtn.disabled = true;
            
            if (type === 'custom') {
                playBtn.innerText = "‚è≥ ËºâÂÖ•...";
                statusMsg.innerText = "‰∏ãËºâÈü≥Êïà...";
                sampler = new Tone.Sampler({
                    urls: {
                        'C4': '01.mp3', 'D4': '02.mp3', 'E4': '03.mp3', 'F4': '04.mp3', 'G4': '05.mp3',
                        'A4': '06.mp3', 'B4': '07.mp3', 'C5': '08.mp3', 'D5': '09.mp3', 'E5': '10.mp3',
                        'F5': '11.mp3', 'G5': '12.mp3', 'A5': '13.mp3', 'B5': '14.mp3', 'C6': '15.mp3'
                    },
                    baseUrl: "./sounds/",
                    onload: () => {
                        globalSynth = sampler;
                        // ÈÄ£Êé•Âà∞ Limiter
                        globalSynth.disconnect();
                        globalSynth.connect(limiter);
                        globalSynth.volume.value = vol;
                        
                        playBtn.disabled = false;
                        playBtn.innerText = "‚ñ∂ Êí≠Êîæ";
                        statusMsg.innerText = "Ëá™Ë®ÇÈü≥Ëâ≤Â∞±Á∑í";
                    },
                    onerror: () => {
                        alert("ÁÑ°Ê≥ïËºâÂÖ•Èü≥Êïà„ÄÇ");
                        playBtn.disabled = false;
                        playBtn.innerText = "‚ñ∂ Êí≠Êîæ";
                        document.getElementById('instrumentSelect').value = 'harp';
                        changeInstrument();
                    }
                }); // ÈÄôË£°‰∏çÁõ¥Êé• toDestinationÔºåËÄåÊòØÂú® onload ÈÄ£Êé•
            } else {
                // ÂêàÊàêÂô®
                synth = new Tone.PolySynth(Tone.Synth);
                // ÈÄ£Êé•Âà∞ Limiter
                synth.connect(limiter);
                globalSynth = synth;
                globalSynth.volume.value = vol;

                const commonEnvelope = { attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.1 };
                switch(type) {
                    case 'piano': synth.set({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 1.5 } }); break;
                    case 'guitar': synth.set({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1 } }); break;
                    case 'synth': synth.set({ oscillator: { type: "square" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }); break;
                    case 'harp': default: synth.set({ oscillator: { type: "triangle" }, envelope: commonEnvelope }); break;
                }
                playBtn.disabled = false;
                playBtn.innerText = "‚ñ∂ Êí≠Êîæ";
                statusMsg.innerText = "ÂÖßÂª∫Èü≥Ëâ≤Â∞±Á∑í";
            }
        }

        async function togglePlay() {
            await ensureAudioInit();
            if (isPlaying) { stopPlay(); } else {
                if (!currentMidi) { alert("Ë´ãÂÖà‰∏äÂÇ≥Ê™îÊ°àÔºÅ"); return; }
                scheduleMusic();
                Tone.Transport.start();
                playBtn.innerText = "‚è∏ Êö´ÂÅú";
                isPlaying = true;
            }
        }

        function stopPlay() {
            if(globalSynth) globalSynth.releaseAll();
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('.key.active').forEach(el => el.classList.remove('active'));
            playBtn.innerText = "‚ñ∂ Êí≠Êîæ";
            isPlaying = false;
        }

        function scheduleMusic() {
            Tone.Transport.cancel();
            let endTime = 0;
            // ËÅ≤Èü≥ÊãâÈï∑Âà∞ 2ÁßíÔºåËÆìÂÖ∂Ëá™ÁÑ∂Ë°∞Ê∏õÔºåÈÅøÂÖçÊñ∑Èü≥
            const AUDIO_DURATION = 2.0; 
            const VISUAL_DURATION = 0.15; 

            currentMidi.tracks.forEach(track => {
                track.notes.forEach(note => {
                    let playMidi = note.midi;
                    if (currentMidi.header) { // MIDI file
                        playMidi += shiftAmount;
                        while (playMidi < 60) playMidi += 12; while (playMidi > 84) playMidi -= 12;
                    }

                    const keyIndex = SKY_NOTES.indexOf(playMidi);
                    if (keyIndex !== -1) {
                        Tone.Transport.schedule((time) => {
                            if(globalSynth) globalSynth.triggerAttackRelease(Tone.Frequency(SKY_NOTES[keyIndex], "midi"), AUDIO_DURATION, time);

                            Tone.Draw.schedule(() => {
                                const el = document.getElementById(`sky-key-${keyIndex}`);
                                if (el) {
                                    el.classList.remove('active');
                                    void el.offsetWidth; 
                                    el.classList.add('active');
                                }
                            }, time);

                            Tone.Draw.schedule(() => {
                                const el = document.getElementById(`sky-key-${keyIndex}`);
                                if (el) el.classList.remove('active');
                            }, time + VISUAL_DURATION);

                        }, note.time);
                        if(note.time + note.duration > endTime) endTime = note.time + note.duration;
                    }
                });
            });
            Tone.Transport.schedule(() => stopPlay(), endTime + 1);
        }

        function downloadScore() {
            controlsPanel.classList.add('hidden');
            toggleBtn.style.display = 'none';
            html2canvas(document.body).then(canvas => {
                const link = document.createElement('a');
                link.download = 'sky_piano_view.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                controlsPanel.classList.remove('hidden');
                toggleBtn.style.display = 'flex';
            });
        }

        let controlsVisible = true;
        function toggleControls() {
            controlsVisible = !controlsVisible;
            if (controlsVisible) {
                controlsPanel.classList.remove('hidden');
                toggleBtn.classList.remove('dimmed');
            } else {
                controlsPanel.classList.add('hidden');
                toggleBtn.classList.add('dimmed');
            }
        }

        initKeyboard();
        changeInstrument();

    </script>
</body>
</html>