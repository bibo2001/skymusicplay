<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky è‡ªå‹•æ¼”å¥æ©Ÿ (V23 æ ¹éŸ³ä¿®æ­£ç‰ˆ)</title>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-gradient: radial-gradient(circle at center bottom, #1a0e2e 0%, #080510 100%);
            
            /* ä»‹é¢é¢¨æ ¼ */
            --key-bg: rgba(0, 0, 0, 0.25); 
            --key-border: rgba(255, 255, 255, 0.5);
            --line-color: #ffffff; 
            --neon-glow: 0 0 4px rgba(255, 255, 255, 0.4); 
            
            /* æŒ‰ä¸‹æ™‚ */
            --active-bg: rgba(255, 255, 255, 0.3); 
            --active-border: #ffffff;
            
            /* UI */
            --control-bg: rgba(44, 44, 46, 0.9);
            --control-border: rgba(255, 255, 255, 0.15);
        }

        body {
            margin: 0; padding: 0;
            background: var(--bg-gradient);
            background-size: cover; background-position: center; background-attachment: fixed;
            color: white; font-family: 'Segoe UI', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            user-select: none; overflow: hidden;
            transition: background-image 0.5s ease;
        }

        .bg-stars {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 150px 160px, #ddd, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 200px 200px;
            opacity: 0.3; z-index: -1;
        }
        body.custom-bg .bg-stars { display: none; }

        /* --- Controls --- */
        .controls {
            position: absolute; top: 20px;
            background: var(--control-bg); backdrop-filter: blur(10px);
            padding: 8px 15px; border-radius: 50px;
            display: flex; gap: 8px; align-items: center;
            border: 1px solid var(--control-border);
            z-index: 100; flex-wrap: wrap; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: transform 0.3s, opacity 0.3s;
        }
        .controls.hidden { transform: translateY(-150%); opacity: 0; pointer-events: none; }

        .btn {
            background: rgba(255,255,255,0.1); color: #eee;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 14px; border-radius: 20px;
            cursor: pointer; font-size: 13px; transition: 0.2s;
            white-space: nowrap;
        }
        .btn:hover { background: rgba(255,255,255,0.25); color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-play { background: #ff7675; color: #fff; border: none; font-weight: bold; }
        .btn-play:hover { background: #ff5252; }

        select {
            background: rgba(255,255,255,0.1); color: #eee;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 10px; border-radius: 20px;
            cursor: pointer; font-size: 13px; outline: none;
        }
        option { background: #333; }

        .color-wrapper {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.1); padding: 3px 10px 3px 3px;
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        input[type="color"] { border: none; width: 24px; height: 24px; cursor: pointer; background: none; padding: 0; border-radius: 50%; }
        .color-label { font-size: 12px; color: #ccc; }

        .separator { width: 1px; height: 18px; background: rgba(255,255,255,0.2); margin: 0 2px; }

        #toggleControlsBtn {
            position: fixed; bottom: 20px; right: 20px;
            width: 45px; height: 45px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 22px; color: white;
            z-index: 101; transition: all 0.3s;
        }
        #toggleControlsBtn:hover { transform: scale(1.1); background: rgba(0,0,0,0.8); }
        #toggleControlsBtn.dimmed { opacity: 0.5; }

        /* --- Keyboard Grid --- */
        .instrument-wrapper { transform: scale(1.1); }
        .keys-grid {
            display: grid;
            grid-template-columns: repeat(5, 90px);
            grid-template-rows: repeat(3, 90px);
            gap: 15px;
        }

        /* --- Key Styles --- */
        .key {
            width: 90px; height: 90px;
            background: var(--key-bg);
            border-radius: 18px; 
            border: 2px solid var(--key-border);
            display: flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.1s ease-out, background 0.1s, border-color 0.1s;
        }

        /* ç·šæ¢æ¨£å¼ */
        .shape-diamond, .shape-circle, .shape-compound {
            position: absolute;
            border: 3px solid var(--line-color); 
            box-shadow: var(--neon-glow);
            pointer-events: none;
            transition: transform 0.1s;
        }

        /* è±å½¢ */
        .shape-diamond { 
            width: 44px; height: 44px; 
            transform: rotate(45deg); 
            border-radius: 4px; 
        }
        
        /* åœ“å½¢ */
        .shape-circle { 
            width: 54px; height: 54px; 
            border-radius: 50%; 
        }
        
        /* è¤‡åˆåœ–å½¢ï¼šå¤–éƒ¨è±å½¢ + å…§éƒ¨åœ“å½¢ */
        .shape-compound {
            width: 44px; height: 44px; 
            transform: rotate(45deg); /* å¤–éƒ¨æ˜¯è±å½¢ */
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .shape-compound::after {
            content: ''; 
            width: 30px; height: 30px; /* å…§éƒ¨å°åœ“ */
            border: 3px solid var(--line-color);
            border-radius: 50%; /* åœ“å½¢ */
            box-shadow: var(--neon-glow);
            /* å› ç‚ºçˆ¶å±¤è½‰äº†45åº¦ï¼Œé€™è£¡ä¸éœ€è¦åè½‰ï¼Œåœ“å½¢è½‰äº†é‚„æ˜¯åœ“å½¢ */
        }

        /* --- Active State --- */
        .key.active {
            transform: scale(0.85);
            background: var(--active-bg);
            border-color: #fff;
            transition: none;
        }

        /* äº®åœˆæ“´æ•£å‹•ç•« */
        .key::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 18px;
            opacity: 0; pointer-events: none; box-sizing: border-box;
        }
        .key.active::after { animation: ringExpand 0.3s ease-out forwards; }

        @keyframes ringExpand {
            0% { width: 100%; height: 100%; opacity: 1; border-width: 4px; }
            100% { width: 140%; height: 140%; opacity: 0; border-width: 0px; }
        }

        #statusMsg { color: #aaa; font-size: 12px; white-space: nowrap; margin-left: 5px; }

    </style>
</head>
<body>

    <div class="bg-stars"></div>

    <div class="controls" id="controlsPanel">
        <input type="file" id="midiFileInput" accept=".mid,.midi" onchange="handleMidiFile(this.files)" style="display:none">
        <button class="btn" id="midiBtn" onclick="document.getElementById('midiFileInput').click()">ğŸ“‚ ä¸Šå‚³ MIDI</button>
        
        <input type="file" id="bgFileInput" accept="image/*" onchange="handleBgFile(this.files)" style="display:none">
        <button class="btn" id="bgBtn" onclick="document.getElementById('bgFileInput').click()">ğŸ–¼ï¸ ä¸Šå‚³èƒŒæ™¯</button>

        <div class="color-wrapper" title="è‡ªè¨‚ç·šæ¢é¡è‰²">
            <input type="color" id="lineColorPicker" value="#ffffff" oninput="updateLineColor(this.value)">
            <span class="color-label">ç·šæ¢</span>
        </div>

        <select id="instrumentSelect" onchange="changeInstrument()">
            <optgroup label="å…§å»ºåˆæˆéŸ³">
                <option value="harp" selected>é è¨­è±ç´</option>
                <option value="piano">é‹¼ç´</option>
                <option value="guitar">å‰ä»–</option>
                <option value="synth">é›»å­éŸ³</option>
            </optgroup>
            <optgroup label="å¤–éƒ¨éŸ³æº">
                <option value="custom">âœ¨ è‡ªè¨‚/åŸè² (sounds/)</option>
            </optgroup>
        </select>

        <div class="separator"></div>

        <button class="btn btn-play" id="playBtn" onclick="togglePlay()">â–¶ æ’­æ”¾</button>
        <button class="btn" onclick="stopPlay()">â–  åœæ­¢</button>
        <button class="btn" onclick="downloadScore()">ğŸ“¥ ä¸‹è¼‰åœ–æª”</button>
        
        <span id="statusMsg">è«‹é¸æ“‡æª”æ¡ˆ...</span>
    </div>

    <div class="instrument-wrapper">
        <div class="keys-grid" id="keyboard"></div>
    </div>

    <div id="toggleControlsBtn" onclick="toggleControls()">ğŸ‘ï¸</div>

    <script>
        // V23 ä¿®æ­£æ’åˆ—ï¼šC4(0), C5(7), C6(14) ç‚ºè¤‡åˆåœ–å½¢
        const SHAPE_LAYOUT = [
            'compound', 'diamond', 'circle', 'diamond', 'circle',    // Row 1: C4 æ˜¯ Compound
            'circle', 'diamond', 'compound', 'diamond', 'circle',    // Row 2: C5 æ˜¯ Compound
            'circle', 'diamond', 'circle', 'diamond', 'compound'     // Row 3: C6 æ˜¯ Compound
        ];

        const SKY_NOTES = [60, 62, 64, 65, 67, 69, 71, 72, 74, 76, 77, 79, 81, 83, 84];

        let currentMidi = null;
        let globalSynth = null;
        let sampler = null;
        let shiftAmount = 0;
        let isPlaying = false;
        
        const keyboard = document.getElementById('keyboard');
        const statusMsg = document.getElementById('statusMsg');
        const playBtn = document.getElementById('playBtn');
        const body = document.body;
        const controlsPanel = document.getElementById('controlsPanel');
        const toggleBtn = document.getElementById('toggleControlsBtn');

        function truncateName(name, maxLength = 8) {
            if (name.length <= maxLength) return name;
            const extIndex = name.lastIndexOf('.');
            if (extIndex !== -1) {
                const ext = name.substring(extIndex);
                const base = name.substring(0, extIndex);
                if (base.length > maxLength - ext.length - 2) {
                    return base.substring(0, maxLength - ext.length - 2) + '..' + ext;
                }
            }
            return name.substring(0, maxLength) + '...';
        }

        function initKeyboard() {
            keyboard.innerHTML = '';
            SHAPE_LAYOUT.forEach((shapeType, index) => {
                const key = document.createElement('div');
                key.className = 'key';
                key.id = `sky-key-${index}`;
                
                const shape = document.createElement('div');
                shape.className = `shape-${shapeType}`;
                
                key.appendChild(shape);
                keyboard.appendChild(key);

                key.addEventListener('mousedown', () => {
                    ensureAudioInit().then(() => {
                        if(globalSynth) {
                            const now = Tone.now();
                            globalSynth.triggerAttackRelease(Tone.Frequency(SKY_NOTES[index], "midi"), 0.3, now);
                        }
                        key.classList.remove('active');
                        void key.offsetWidth; 
                        key.classList.add('active');
                        setTimeout(() => key.classList.remove('active'), 150);
                    });
                });
            });
        }

        function updateLineColor(color) {
            document.documentElement.style.setProperty('--line-color', color);
            const r = parseInt(color.substr(1,2), 16);
            const g = parseInt(color.substr(3,2), 16);
            const b = parseInt(color.substr(5,2), 16);
            document.documentElement.style.setProperty('--neon-glow', `0 0 4px rgba(${r},${g},${b},0.6)`);
        }

        async function handleMidiFile(files) {
            if (files.length === 0) return;
            stopPlay();
            statusMsg.innerText = "è§£æä¸­...";
            const btn = document.getElementById('midiBtn');
            btn.innerText = 'ğŸ“‚ ' + truncateName(files[0].name);
            btn.title = files[0].name;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { currentMidi = new Midi(e.target.result); autoRecommend(); } 
                catch (err) { statusMsg.innerText = "å¤±æ•—"; }
            };
            reader.readAsArrayBuffer(files[0]);
        }

        function handleBgFile(files) {
            if (files.length === 0) return;
            const btn = document.getElementById('bgBtn');
            btn.innerText = 'ğŸ–¼ï¸ ' + truncateName(files[0].name);
            btn.title = files[0].name;
            const file = files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                body.style.backgroundImage = `url('${e.target.result}')`;
                body.classList.add('custom-bg');
            };
            reader.readAsDataURL(file);
        }

        function autoRecommend() {
            if(!currentMidi) return;
            stopPlay();
            let bestShift = 0;
            let minInvalid = Infinity;
            for(let s = -11; s <= 11; s++) {
                let invalid = 0;
                currentMidi.tracks.forEach(track => {
                    track.notes.forEach(note => {
                        let m = note.midi + s;
                        while (m < 60) m += 12; while (m > 84) m -= 12;
                        if (!SKY_NOTES.includes(m)) invalid++;
                    });
                });
                if(invalid < minInvalid) { minInvalid = invalid; bestShift = s; }
            }
            shiftAmount = bestShift;
            statusMsg.innerText = `å°±ç·’ (è‡ªå‹•è½‰èª¿ ${shiftAmount > 0 ? '+' : ''}${shiftAmount})`;
        }

        async function ensureAudioInit() {
            if (Tone.context.state !== 'running') { await Tone.start(); }
            if (!globalSynth) { await changeInstrument(); }
        }

        async function changeInstrument() {
            const type = document.getElementById('instrumentSelect').value;
            if(isPlaying) stopPlay();
            if (globalSynth) { globalSynth.releaseAll(); }
            playBtn.disabled = true;
            
            if (type === 'custom') {
                playBtn.innerText = "â³ è¼‰å…¥...";
                statusMsg.innerText = "ä¸‹è¼‰éŸ³æ•ˆ...";
                sampler = new Tone.Sampler({
                    urls: {
                        'C4': '01.mp3', 'D4': '02.mp3', 'E4': '03.mp3', 'F4': '04.mp3', 'G4': '05.mp3',
                        'A4': '06.mp3', 'B4': '07.mp3', 'C5': '08.mp3', 'D5': '09.mp3', 'E5': '10.mp3',
                        'F5': '11.mp3', 'G5': '12.mp3', 'A5': '13.mp3', 'B5': '14.mp3', 'C6': '15.mp3'
                    },
                    baseUrl: "./sounds/",
                    onload: () => {
                        globalSynth = sampler;
                        globalSynth.volume.value = -5;
                        playBtn.disabled = false;
                        playBtn.innerText = "â–¶ æ’­æ”¾";
                        statusMsg.innerText = "è‡ªè¨‚éŸ³è‰²å°±ç·’";
                    },
                    onerror: () => {
                        alert("ç„¡æ³•è¼‰å…¥éŸ³æ•ˆã€‚");
                        playBtn.disabled = false;
                        playBtn.innerText = "â–¶ æ’­æ”¾";
                        document.getElementById('instrumentSelect').value = 'harp';
                        changeInstrument();
                    }
                }).toDestination();
            } else {
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                globalSynth = synth;
                const commonEnvelope = { attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.1 };
                switch(type) {
                    case 'piano': synth.set({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 1.5 } }); synth.volume.value = -5; break;
                    case 'guitar': synth.set({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1 } }); synth.volume.value = -8; break;
                    case 'synth': synth.set({ oscillator: { type: "square" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }); synth.volume.value = -10; break;
                    case 'harp': default: synth.set({ oscillator: { type: "triangle" }, envelope: commonEnvelope }); synth.volume.value = -5; break;
                }
                playBtn.disabled = false;
                playBtn.innerText = "â–¶ æ’­æ”¾";
                statusMsg.innerText = "å…§å»ºéŸ³è‰²å°±ç·’";
            }
        }

        async function togglePlay() {
            await ensureAudioInit();
            if (isPlaying) { stopPlay(); } else {
                if (!currentMidi) { alert("è«‹å…ˆä¸Šå‚³ MIDI æª”æ¡ˆï¼"); return; }
                scheduleMusic();
                Tone.Transport.start();
                playBtn.innerText = "â¸ æš«åœ";
                isPlaying = true;
            }
        }

        function stopPlay() {
            if(globalSynth) globalSynth.releaseAll();
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('.key.active').forEach(el => el.classList.remove('active'));
            playBtn.innerText = "â–¶ æ’­æ”¾";
            isPlaying = false;
        }

        function scheduleMusic() {
            Tone.Transport.cancel();
            let endTime = 0;
            const FIXED_DURATION = 0.3; 
            const VISUAL_DURATION = 0.15; 

            currentMidi.tracks.forEach(track => {
                track.notes.forEach(note => {
                    let playMidi = note.midi + shiftAmount;
                    while (playMidi < 60) playMidi += 12; while (playMidi > 84) playMidi -= 12;
                    const keyIndex = SKY_NOTES.indexOf(playMidi);
                    if (keyIndex !== -1) {
                        Tone.Transport.schedule((time) => {
                            if(globalSynth) globalSynth.triggerAttackRelease(Tone.Frequency(playMidi, "midi"), FIXED_DURATION, time);

                            Tone.Draw.schedule(() => {
                                const el = document.getElementById(`sky-key-${keyIndex}`);
                                if (el) {
                                    el.classList.remove('active');
                                    void el.offsetWidth; 
                                    el.classList.add('active');
                                }
                            }, time);

                            Tone.Draw.schedule(() => {
                                const el = document.getElementById(`sky-key-${keyIndex}`);
                                if (el) el.classList.remove('active');
                            }, time + VISUAL_DURATION);

                        }, note.time);
                        if(note.time + note.duration > endTime) endTime = note.time + note.duration;
                    }
                });
            });
            Tone.Transport.schedule(() => stopPlay(), endTime + 1);
        }

        function downloadScore() {
            controlsPanel.classList.add('hidden');
            toggleBtn.style.display = 'none';
            html2canvas(document.body).then(canvas => {
                const link = document.createElement('a');
                link.download = 'sky_piano_view.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                controlsPanel.classList.remove('hidden');
                toggleBtn.style.display = 'flex';
            });
        }

        let controlsVisible = true;
        function toggleControls() {
            controlsVisible = !controlsVisible;
            if (controlsVisible) {
                controlsPanel.classList.remove('hidden');
                toggleBtn.classList.remove('dimmed');
            } else {
                controlsPanel.classList.add('hidden');
                toggleBtn.classList.add('dimmed');
            }
        }

        initKeyboard();
        changeInstrument();

    </script>
</body>
</html>